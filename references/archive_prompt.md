# 步骤 6：测试验证 & 步骤 7：归档

## 使用时机

单 CP 执行模式的第 6-7 步。在步骤 5（Apply 施工）完成后自动进入。

## 步骤 6：测试验证

```bash
# 运行单元测试
pytest / npm test

# 运行集成测试（如有）
# 手动 smoke test（关键路径）
```

- **测试全绿** → 进入**步骤 7：归档**，不要停下等待
- **测试失败** → 修复后重新测试，最多 3 次重试

## 步骤 7：归档

### 归档前检查

```
## 检查点 1：测试覆盖

【自动检查】检查本次提案中，是否前后端所有功能均添加了自动化测试。
- 如有缺失，自动补充测试用例
- 不要等待用户确认

## 检查点 2：全量测试

【自动执行】在本仓库执行全量测试，并将所有失败修复到全绿，同时汇总 warnings。

### 目标与原则（必须遵循）

1. 对每个失败先做根因分析，再修复；修复应与本次开发提案/架构方向一致
2. 允许对提案涉及的模块做结构性修复，对提案无关区域优先最小必要改动
3. 禁止取巧：不得通过 skip/xfail、删除测试、显著弱化断言来让测试通过
4. 若测试本身与提案或真实行为不一致，允许修改测试，但必须说明依据

## 检查点 3：确认与归档

【自动确认】
1. 自动确认 tasks 全部完成（如有未完成，记录到 AUDIT.md 并继续）
2. 自动确认 spec delta 已合并且与实现一致
3. 如有遗留项，必须显式记录为后续 change
4. 执行 openspec archive <change-id> --yes
5. 最后执行 git commit，只提交本次提案相关文件
   - 在 git 备注中简要阐述本提案和执行过程
```

### 归档命令

```bash
# 归档 change
openspec archive <change-id> --yes
```

### 归档完成后的行为

- **单 CP 执行模式**：归档完成后 → 输出完成报告，流程结束
- **多 CP 批量执行**：归档完成后 → 继续处理下一个 CP，不要停下等待确认

## 审计日志要求

**步骤 6 开始时**：在 AUDIT.md 时间线中添加

```markdown
| 步骤6：测试验证 | [开始时间] | | | 进行中 |
```

**步骤 7 开始时**：在 AUDIT.md 时间线中添加

```markdown
| 步骤7：归档 | [开始时间] | | | 进行中 |
```

**流程结束时**：
1. 更新 AUDIT.md 时间线（记录所有步骤的结束时间和耗时）
2. 汇总所有文件变更到 AUDIT.md 变更索引
3. 输出完成报告
