# 批量执行开发计划 (Batch Execute)

## 使用场景

当用户提供一个包含多个 change proposals 的开发计划文件时，自动遍历所有 CP 并执行完整开发流程。

## 输入格式

**开发计划文件格式** (Markdown)：

```markdown
# 开发计划

## CP-1: [简短标题]

描述：用户可见的功能描述
优先级：高 / 中 / 低
备注：可选的额外说明

## CP-2: [简短标题]
...
```

## 执行流程

### 阶段 0: 准备与验证

1. **加载项目上下文**
   - 运行 `openspec list` 查看现有活跃 changes
   - 读取 `openspec/project.md` 获取项目规则
   - 查阅已归档提案（changes/archive/），了解历史决策
   - 扫描与本次提案相关的已实现代码，确保一致性
   - 检查现有测试框架

### 阶段 1: 对每个 CP 执行完整流程

按 cps.md 文件中的顺序，从前向后依次执行每个 CP：

#### 1.1 创建 Proposal

从简略描述展开为完整 proposal：

- 参考 `references/proposal_single_prompt.md`
- **自动决策规则**：
  - 数据模型：参考现有代码模式，保持一致性
  - API 设计：遵循项目 RESTful / GraphQL 规范
  - 技术选型：优先使用项目已有依赖
  - 文件位置：遵循项目目录命名规范

- 输出：`changes/[change-id]/proposal.md`

**验证提案**：
```bash
openspec validate <change-id> --strict
```
- 修复所有验证错误后继续

#### 1.2 Design + Tasks 拆解

参考 `references/design_tasks_prompt.md`

- 任务粒度：0.5-1 天/条
- 每条任务包含：目的、改动文件、关键点、验收
- 标注依赖关系

- 输出：`changes/[change-id]/tasks.md`

#### 1.3 3 道关卡快速审查

参考 `references/three_gates_prompt.md`，采用**快速决策模式**：

| 关卡 | 处理方式 |
|------|----------|
| 复述对齐 | 自动生成，如有歧义基于常识推断，记录决策 |
| 边界与异常 | 列出常见场景，非核心边界推迟到后续 change |
| 可执行性 | 确保每条任务可独立完成 |

**TBD 决策策略**：
- 以首席架构师和首席开发者的双重视角分析
- 站在对项目整体最有利的角度决策
- 不怕难，也不搞过度复杂
- 基于 `openspec/project.md` 的原则做决策
- 代价风险分析：给出 3 种方案（简单/中等/稳健），比较复杂度、风险、扩展成本
- 所有 TBD 决策必须记录到 `DECISIONS.md`（包含推理过程）

#### 1.4 评审提案

参考 `references/proposal_review_prompt.md`

**评审内容**：
- 对比 `openspec/project.md` 检查规范对齐
- 查阅已归档提案，了解历史决策和实现方式
- 扫描与本次提案相关的已实现代码，确保一致性
- **Type A（违规）**：与现有体系不兼容且无必要，直接重写
- **Type B（演进）**：偏离规范但代表更优解，保留并论证

#### 1.5 Apply 执行

参考 `references/apply_prompt.md`

- 严格按 `tasks.md` 顺序执行
- 每完成一项打勾
- 使用 `TodoWrite` 跟踪实时进度

**质量保障**：
- 每个任务完成后，运行相关测试
- 新功能必须配套自动化测试
- 提交前确保测试全绿

#### 1.6 测试验证

```bash
# 运行单元测试
pytest / npm test

# 运行集成测试（如有）
# 手动 smoke test（关键路径）
```

- **测试全绿** → 继续
- **测试失败** → 修复后重新测试，最多 3 次重试

#### 1.7 条件性 Archive

参考 `references/archive_prompt.md`

**Archive 条件**：
- [ ] 所有 tasks 完成
- [ ] 测试全绿
- [ ] 无遗留 TBD（或已记录到后续 change）
- [ ] 代码已提交

**任一条件不满足** → 暂停当前 CP，报告问题，等待用户指示

### 阶段 2: 生成执行报告

所有 CP 处理完成后，生成 `BATCH_EXECUTION_REPORT.md`：

```markdown
# 批量执行报告

执行时间：YYYY-MM-DD HH:MM

## 执行摘要

- 计划 CP 数：N
- 成功完成：M
- 失败/跳过：K
- 总耗时：X 小时

## CP 执行详情

### CP-1: [名称] ✓

- 状态：成功
- 耗时：2h 15m
- 提案：changes/2026-01-05-1-xxx/proposal.md
- 审计：changes/2026-01-05-1-xxx/AUDIT.md
- 关键决策：
  - TBD 1: 决策内容（见 DECISIONS.md）
  - TBD 2: 决策内容（见 DECISIONS.md）
- 测试：通过 (单元 42/42, 集成 5/5)

### CP-2: [名称] ⚠️

- 状态：失败 / 暂停
- 耗时：1h 30m
- 原因：xxx
- 建议：xxx

## 审计追踪

| CP | AUDIT.md | 快照数 | 决策数 |
|----|----------|--------|--------|
| CP-1 | [链接](changes/2026-01-05-1-xxx/AUDIT.md) | 5 | 3 |
| CP-2 | [链接](changes/2026-01-05-2-yyy/AUDIT.md) | 3 | 1 |

## 决策日志

所有自动决策的详细记录...（见各 CP 的 DECISIONS.md）

## 遗留问题

需要人工介入的事项...
```

## 错误处理策略

| 场景 | 处理方式 |
|------|----------|
| 任务执行失败 | 修复重试，最多 3 次；仍失败则暂停并报告 |
| 测试失败 | 修复后重测；破坏性变更导致失败则暂停 |
| 需要用户输入 | 基于 openspec/project.md 做合理推断，记录决策，最后报告 |

## 关键原则

1. **快速迭代优于完美设计** - 先跑通再优化
2. **测试是安全网** - 没有测试的代码不归档
3. **决策透明化** - 所有自动决策必须可追溯
4. **项目利益优先** - 站在对项目整体最有利的角度决策，不偏不倚
5. **尊重项目规范** - 所有决策基于 openspec/project.md 原则
