# 步骤 3：提案细化

## 使用时机

单 CP 执行模式的第 3 步。在步骤 2（设计拆解）完成后自动进入。

## 关卡 1：复述对齐（防止理解偏差）

```
1. 用 10 行以内复述：
   - 这个 change 要解决什么问题
   - 交付什么
   - 明确不做什么
   - 如何验收

2. 分析提案各个文件（proposal.md, spec.md, tasks.md）中还有没有任何含糊词
   - 例如："支持""优化""完善"
   - 必须改成可测试描述

3. 如果还有哪些细节不确定，需要决策的，现在全部列出来
   - 在调研已有规范和已有实现的基础上
   - 对这些细节给出建议
   - 确保建议对项目整体更有利、更正确
```

## 关卡 2：边界与异常（防止线上事故）

```
列出所有能想到的边界/异常场景：
- 标注哪些纳入本次 scope
- 标注哪些明确推迟
- 对纳入项给出期望系统行为
```

## 关卡 3：可执行性（防止 tasks 变口号）

```
检查 tasks：
- 每条是否有明确输出物（代码/测试/文档）
- 是否能独立完成
- 是否能在 0.5–1 天内完成（不能就重拆）

确认以后：
- 删除 tasks 中关于工作量（天）的描述
- 在不影响提案整体功能的实现上，测试要尽量覆盖边界情况
```

## TBD 自动决策：代价与风险分析

在每个环节中遇到 TBD 时，进行代价风险分析：

```
给出 3 种实现方案：
1. 简单方案
2. 中等方案
3. 稳健方案

比较维度：
- 复杂度
- 风险
- 未来扩展成本

推荐一种并解释权衡。
```

**决策原则**：
- 站在对项目整体最有利的角度决策
- 以首席架构师和首席开发者的视角综合判断
- 不怕难，也不搞过度复杂
- 基于 `openspec/project.md` 的原则做决策
- 所有 TBD 决策记录到 `DECISIONS.md`（包含推理过程）

- 完成后 → 进入**步骤 4：评审提案**，不要停下等待确认

## 人机协同原则

不是"让 AI 继续写"，而是"不断把含糊变成确定"。

在每个阶段按照这三道关卡检查提案：
1. 自己复述
2. 列出边界
3. 确认可执行性

同时，对 TBD 问题进行代价风险分析。

## 审计日志要求

**审计即执行：每完成一个动作必须立即更新审计日志**

### 审计检查点

**每完成一个动作后，立即执行以下操作**：

```bash
# 1. 获取当前时间（必须使用命令，禁止猜测）
date "+%Y-%m-%d %H:%M:%S"

# 2. 立即更新 AUDIT.md 或 DECISIONS.md
# 3. 如有文件变更，立即创建 .audit/ 快照
```

### 步骤开始时

在 AUDIT.md 时间线中添加

```markdown
| 步骤3：提案细化 | [使用 date 命令获取] | | | 进行中 |
```

### 每做一次 TBD 决策后（立即执行）

```bash
# 1. 获取时间
TIME=$(date "+%Y-%m-%d %H:%M:%S")

# 2. 立即更新 DECISIONS.md
# 3. 立即更新 AUDIT.md 决策记录索引
```

### 步骤结束时验证

提案细化完成后，必须执行：

```bash
# 验证提案格式
openspec validate <change-id> --strict

# 查看 delta 详情
openspec show <change-id> --json --deltas-only
```

- 修复所有验证错误后继续
- 验证通过后 → 进入**步骤 4：评审提案**

### 步骤结束时

```bash
# 1. 获取结束时间
END_TIME=$(date "+%Y-%m-%d %H:%M:%S")

# 2. 计算耗时
# 3. 更新 AUDIT.md 时间线
# 4. 如有文件修改，创建 .audit/ 快照
```

### 步骤结束时创建 STATE_RELOAD.md

**步骤 3 结束时必须创建 STATE_RELOAD.md**（这是第一个压缩恢复点！）：

```bash
# 参考模板：./spec-runner/references/templates/STATE_RELOAD.md
# 创建文件：
./openspec/changes/[change-id]/STATE_RELOAD.md
```

**必填内容**：
- Change ID
- 当前步骤：步骤 3 结束
- 下一步：步骤 4 评审提案
- 核心原则（从 SKILL.md 提炼）
- 提案关键信息（从 proposal.md 提炼）
- 下一步行动：评审提案与现有体系的兼容性

**禁止延迟记录或批量记录审计信息。**

### DECISIONS.md 格式

每个 TBD 决策必须立即记录到 DECISIONS.md：

```markdown
## TBD-1: [决策标题]

**环节**: 复述对齐 / 边界与异常 / 可执行性
**时间**: [使用 date 命令获取]

**问题描述**:
[原 TBD 问题]

**分析过程**:
[推理过程，包含 3 种方案比较]

**最终决策**:
[选定的方案]

**权衡说明**:
[为什么选择这个方案]
```
