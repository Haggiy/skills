# 步骤 7：Git 提交

## 使用时机

单 CP 执行模式的第 7 步。在步骤 6（归档）完成后自动进入。

**本步骤必须执行，不得跳过或延迟。**

## 核心原则

| 原则 | 说明 |
|------|------|
| **自动执行** | 不等待用户确认，自动执行 git 操作 |
| **精确范围** | 只提交本次 change 相关的文件 |
| **规范消息** | commit message 包含 change-id 和概要 |
| **完整记录** | commit 记录到 AUDIT.md |
| **最终核查** | Git 提交前必须完成所有核查项 |

## 执行步骤

### 步骤 7.1：最终核查（Git 提交前必须执行）

**在执行任何 git 操作之前，必须完成以下核查**：

#### 核查 1：Spec 文档完整性

```bash
# 验证提案格式
openspec validate <change-id> --strict

# 查看 delta 详情，确认所有变更都已记录
openspec show <change-id> --json --deltas-only
```

#### 核查 2：任务完成情况

```bash
# 检查所有任务是否都已打勾
grep "\- \[ \]" changes/<change-id>/tasks.md
# 如果输出有任何内容，说明有未完成任务，必须先完成

# 确认所有任务已完成
grep "\- \[x\]" changes/<change-id>/tasks.md | wc -l
# 应该等于任务总数
```

#### 核查 3：提案整体符合要求

```bash
# 检查必需文件是否存在
ls changes/<change-id>/proposal.md
ls changes/<change-id>/tasks.md
ls changes/<change-id>/AUDIT.md
ls changes/<change-id>/specs/
```

#### 核查 4：全量测试验证（必须再次确认）

```bash
# 在 Git 提交前，必须再次运行全量测试确认

# 1. 运行所有 pytest 测试
pytest -v

# 2. 运行 e2e 测试（如果有）
pytest tests/e2e/ -v
# 或
pytest e2e/ -v
# 或
npm run test:e2e

# 3. 确认所有测试通过（输出中无 failed）
```

**通过标准**：所有类型测试全绿，无任何 failed
**不通过处理**：修复问题后重新核查，不得跳过此步骤

#### 核查结果处理

| 核查项 | 通过标准 | 不通过处理 |
|--------|----------|-----------|
| Spec 文档完整性 | `openspec validate` 无错误 | 修复后重新验证 |
| 任务完成情况 | 所有任务都是 `[x]` | 完成未完成任务 |
| 提案符合要求 | 所有必需文件存在 | 补充缺失文件 |
| 全量测试验证 | 所有测试全绿（pytest + e2e） | 修复失败的测试 |

**只有所有核查项都通过后，才能执行 git 操作。**

### 步骤 7.2：获取当前时间

```bash
# 获取准确时间，禁止猜测
date "+%Y-%m-%d %H:%M:%S"
```

### 步骤 7.3：查看变更

```bash
# 查看当前变更状态
git status
```

### 步骤 7.4：添加文件

```bash
# 只添加本次 change 相关的文件
git add openspec/changes/[change-id]/
git add openspec/specs/[相关capability]/
# 如有代码文件变更，一并添加
```

**禁止添加的内容**：
- 临时文件、日志文件
- 不相关的配置文件
- node_modules、__pycache__ 等依赖目录

### 步骤 7.5：生成 Commit Message

**格式规范**：

```
[change-id]: 简短描述

详细说明（可选）：

- 完成事项 1
- 完成事项 2

🤖 Generated by [Claude Code](https://claude.com/claude-code)
Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

**示例**：

```
2026-01-07-1-add-user-auth: 实现用户认证功能

- 实现邮箱+密码注册
- 实现 JWT 登录
- 添加密码重置功能
- 配套单元测试和集成测试

🤖 Generated by [Claude Code](https://claude.com/claude-code)
Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

### 步骤 7.6：执行提交

```bash
# 使用 HEREDOC 确保格式正确
git commit -m "$(cat <<'EOF'
[commit message 内容]
EOF
)"
```

### 步骤 7.7：获取 Commit Hash

```bash
# 获取刚提交的 hash
git rev-parse HEAD
# 或
git log -1 --format='%H'
```

### 步骤 7.8：记录到 AUDIT.md

更新 AUDIT.md，添加步骤 7 的完成记录：

```markdown
### 7. Git 提交

**执行时间**: YYYY-MM-DD HH:MM - HH:MM
**耗时**: Xm
**状态**: ✓

**Git Commit**:
```
Commit: [commit hash]
Message: [commit message 第一行]
```
```

## 审计日志要求

**步骤开始时**：在 AUDIT.md 时间线中添加

```markdown
| 步骤8：Git提交 | [开始时间] | | | 进行中 |
```

**步骤结束时**：
1. 更新 AUDIT.md 时间线（记录结束时间和耗时）
2. 记录 commit hash 和 message
3. 完成整个单 CP 执行流程

## 完成后行为

- **单 CP 执行模式**：输出完成报告，流程结束
- **多 CP 批量执行**：继续处理下一个 CP，不要停下等待确认

## 常见问题处理

| 问题 | 处理方式 |
|------|----------|
| git add 后没有变更 | 检查是否已提交，记录到 AUDIT.md，继续 |
| pre-commit hook 失败 | 修复问题后重新提交，最多重试 3 次 |
| commit message 格式错误 | 检查 HEREDOC 格式，重新提交 |
