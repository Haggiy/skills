# 步骤 3：3 道关卡打磨

## 使用时机

单 CP 执行模式的第 3 步。在步骤 2（设计拆解）完成后自动进入。

## 关卡 1：复述对齐（防止理解偏差）

```
1. 用 10 行以内复述：
   - 这个 change 要解决什么问题
   - 交付什么
   - 明确不做什么
   - 如何验收

2. 分析提案各个文件（proposal.md, spec.md, tasks.md）中还有没有任何含糊词
   - 例如："支持""优化""完善"
   - 必须改成可测试描述

3. 如果还有哪些细节不确定，需要决策的，现在全部列出来
   - 在调研已有规范和已有实现的基础上
   - 对这些细节给出建议
   - 确保建议对项目整体更有利、更正确
```

## 关卡 2：边界与异常（防止线上事故）

```
列出 15 个边界/异常场景：
- 标注哪些纳入本次 scope
- 标注哪些明确推迟
- 对纳入项给出期望系统行为
```

## 关卡 3：可执行性（防止 tasks 变口号）

```
检查 tasks：
- 每条是否有明确输出物（代码/测试/文档）
- 是否能独立完成
- 是否能在 0.5–1 天内完成（不能就重拆）

确认以后：
- 删除 tasks 中关于工作量（天）的描述
- 在不影响提案整体功能的实现上，测试要尽量覆盖边界情况
```

## TBD 自动决策：代价与风险分析

在每个关卡中遇到 TBD 时，进行代价风险分析：

```
给出 3 种实现方案：
1. 简单方案
2. 中等方案
3. 稳健方案

比较维度：
- 复杂度
- 风险
- 未来扩展成本

推荐一种并解释权衡。
```

**决策原则**：
- 站在对项目整体最有利的角度决策
- 以首席架构师和首席开发者的视角综合判断
- 不怕难，也不搞过度复杂
- 基于 `openspec/project.md` 的原则做决策
- 所有 TBD 决策记录到 `DECISIONS.md`（包含推理过程）

- 完成后 → 进入**步骤 4：评审提案**，不要停下等待确认

## 人机协同原则

不是"让 AI 继续写"，而是"不断把含糊变成确定"。

在每个阶段按照这三道关卡检查提案：
1. 自己复述
2. 列出边界
3. 确认可执行性

同时，对 TBD 问题进行代价风险分析。

## 审计日志要求

**步骤开始时**：在 AUDIT.md 时间线中添加

```markdown
| 步骤3：3道关卡 | [开始时间] | | | 进行中 |
```

**每个 TBD 决策**：记录到 DECISIONS.md

```markdown
# 决策日志

## TBD-1: [决策标题]

**关卡**: 复述对齐 / 边界与异常 / 可执行性
**时间**: [时间戳]

**问题描述**:
[原 TBD 问题]

**分析过程**:
[推理过程，包含 3 种方案比较]

**最终决策**:
[选定的方案]

**权衡说明**:
[为什么选择这个方案]
```

**步骤结束时**：
1. 更新 AUDIT.md 时间线
2. 在 `.audit/` 创建快照（如有文件修改）
3. 在 AUDIT.md 中更新决策记录索引
