# 步骤 5：Apply 施工

## 使用时机

单 CP 执行模式的第 5 步。在步骤 4（评审提案）完成后自动批准并进入。

## Prompt 模板

```
specs 已对齐，提案已自动批准（spec-runner 模式）。

请从 tasks.md 开始实现：
- 严格按任务顺序执行
- 每完成一项逐项打勾
- 遇到不明确之处基于项目规范自主决策并记录到 DECISIONS.md
- 使用 TodoWrite 跟踪实时进度

**参考**：详见 `00_testing_helper.md` 的测试执行原则。

每个任务必须配套自动化测试，测试全绿后才能打勾：
1. 实现功能代码
2. 编写/更新测试（覆盖所有测试场景）
3. 运行本功能测试
4. 测试全绿 → 打勾
   测试失败 → 修复 → 重测（最多 3 次）

tasks.md 全部完成后，进入**步骤 6：归档**（归档前会执行全量测试）。

完成上述所有步骤后，继续下一步骤，不要停下等待确认。
```

## 核心要求

1. **严格按顺序**：不要跳过或重排任务
2. **逐项确认**：每完成一项打勾后再进行下一项
3. **自主决策**：遇到不明确之处基于项目规范自主决策并记录到 DECISIONS.md
4. **测试前置**：每任务打勾前必须运行本功能测试，全绿才能打勾

## 每个任务的执行流程

```
1. 实现功能代码（按任务要求）
2. 编写/更新测试（覆盖 tasks.md 中定义的所有测试场景）
3. 运行本功能测试：pytest tests/xxx_test.py -v
4. 测试全绿 → 打勾，进入下一个任务
   测试失败 → 修复代码/测试 → 重测（最多 3 次）
```

## 测试验证原则

| 原则 | 说明 |
|------|------|
| **场景覆盖** | 必须覆盖 tasks.md 中定义的所有测试场景 |
| **全绿才能打勾** | 测试不通过不能打勾，必须修复后重测 |
| **最多重试 3 次** | 同一个测试失败最多重试 3 次 |
| **禁止取巧** | 不得通过 skip/xfail、删除测试、弱化断言让测试通过 |

## 禁止行为

- 使用 `@pytest.mark.skip` 或 `test.skip()` 跳过失败的测试
- 使用 `@pytest.mark.xfail` 标记预期失败
- 删除或注释失败的测试用例
- 弱化断言（如把 `assertEqual` 改为 `assertIn`）
- 延迟测试到步骤 6

## 质量保障

- 每个任务完成后，运行相关测试
- 新功能必须配套自动化测试
- 提交前确保测试全绿

## 审计日志要求

**审计即执行：每完成一个动作必须立即更新审计日志**

### 审计检查点（必须执行）

**每完成一个动作后，立即执行以下操作**：

```bash
# 1. 获取当前时间（必须使用命令，禁止猜测）
date "+%Y-%m-%d %H:%M:%S"

# 2. 立即更新 AUDIT.md
# 3. 如有文件变更，立即创建 .audit/ 快照
```

### 步骤开始时

在 AUDIT.md 时间线中添加

```markdown
| 步骤5：Apply施工 | [使用 date 命令获取] | | | 进行中 |
```

### 每完成一个任务后（立即执行）

```bash
# 1. 获取时间
TIME=$(date "+%Y-%m-%d %H:%M:%S")

# 2. 立即在 AUDIT.md 中记录任务进度和测试结果
# 3. 如有代码变更，立即在 .audit/ 创建快照
# 4. 更新文件变更索引
```

### 任务测试记录格式

```markdown
#### 任务 N：[任务名称]

**测试场景**:
- 场景1: [描述] → ✓
- 场景2: [描述] → ✓
- 场景3: [描述] → ✓

**测试文件**: tests/xxx_test.py
**测试命令**: pytest tests/xxx_test.py -v
**测试结果**: ✓ 全绿（X/X 通过）
**覆盖 Scenarios**: N/N（补充边界场景 M 个）
```

### 步骤结束时

```bash
# 1. 获取结束时间
END_TIME=$(date "+%Y-%m-%d %H:%M:%S")

# 2. 计算耗时
# 3. 更新 AUDIT.md 时间线
# 4. 汇总所有文件变更到 AUDIT.md 变更索引
```

**禁止延迟记录或批量记录审计信息。每完成一个任务立即记录。**
