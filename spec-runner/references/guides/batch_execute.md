# 多 CP 批量执行

## 使用场景

当用户提供一个包含多个 change proposals 的开发计划文件时使用。

## 核心逻辑

**多 CP 批量执行 = 准备阶段 + 循环执行单 CP 流程 + 生成报告**

```
┌─────────────────────────────────────────────────────────────┐
│  阶段 0：准备阶段                                           │
│     └─ 加载项目上下文、解析 cps.md 识别所有 CP               │
├─────────────────────────────────────────────────────────────┤
│  阶段 1：循环执行单 CP 流程                                  │
│                                                             │
│     for each CP in cps.md (按顺序):                         │
│       ┌───────────────────────────────────────────────────┐ │
│       │  调用单 CP 执行模式 (7 步流程)                      │ │
│       │  见 SKILL.md "单 CP 执行模式" 章节                   │ │
│       │                                                   │ │
│       │  步骤 1 → 步骤 2 → 步骤 3 → 步骤 4                  │ │
│       │    → 步骤 5 → 步骤 6 → 步骤 7                      │ │
│       │                                                   │ │
│       │  - 任一阶段失败：记录到 AUDIT.md，继续下一个 CP     │ │
│       │  - 归档条件不满足：记录问题，继续下一个 CP           │ │
│       └───────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  阶段 2：生成执行报告                                       │
│     └─ 输出 BATCH_EXECUTION_REPORT.md                       │
└─────────────────────────────────────────────────────────────┘
```

## spec-runner 执行原则

**必须连续执行，不得停下等待确认**

- 所有阶段之间自动流转
- 遇到不明确之处：基于 openspec/project.md 自主决策，记录到 DECISIONS.md
- 遇到错误：修复重试最多 3 次，仍失败则记录到 AUDIT.md 并继续下一个 CP
- 验证阶段：自动运行验证，无需等待用户批准

**关键词解读**：所有"请确认"、"如果需要"、"建议"等词都应解读为"自动执行并记录"。

## 输入格式

**开发计划文件格式** (Markdown)：

```markdown
# 开发计划

## CP-1: add-user-auth
描述：实现用户认证功能
优先级：高

## CP-2: add-profile-management
描述：用户资料管理
优先级：中
```

## 阶段 0：准备阶段

1. **加载项目上下文**
   - 运行 `openspec list` 查看现有活跃 changes
   - 读取 `openspec/project.md` 获取项目规则
   - 查阅已归档提案（changes/archive/），了解历史决策
   - 扫描与本次提案相关的已实现代码，确保一致性
   - 检查现有测试框架
   - 解析 cps.md，识别所有 CP

## 阶段 1：循环执行单 CP 流程

按 cps.md 文件中的顺序，从前向后依次执行每个 CP。

### 每个 CP 开始时的状态检查

**由于多 CP 模式上下文累积更快，每个 CP 开始前必须执行**：

```bash
# 1. 自我检查：能否回忆核心原则？
# 2. 检查是否需要恢复（上下文是否被压缩）
# 3. 如果是，读取 STATE_RELOAD.md 和 AUDIT.md
# 4. 确认当前是第 X/Y 个 CP
# 5. 继续执行
```

**压缩恢复步骤**：
```bash
# 1. 读取上一个 CP 的 STATE_RELOAD.md
cat ./openspec/changes/[上一个-change-id]/STATE_RELOAD.md

# 2. 读取当前 CP 的 STATE_RELOAD.md（如果存在）
cat ./openspec/changes/[当前-change-id]/STATE_RELOAD.md

# 3. 重新读取 SKILL.md 刷新核心原则
cat ./spec-runner/SKILL.md
```

### CP 之间的状态隔离

- 每个 CP 执行完成后，更新 STATE_RELOAD.md
- 记录当前进度（已完成 X/Y 个 CP）
- 下一个 CP 开始时使用这些信息恢复

**每个 CP 执行步骤**（详见 SKILL.md "单 CP 执行模式"）：

| 步骤 | 说明 | 参考 prompt 文件 |
|------|------|-----------------|
| 1 | 创建提案 | `steps/01_proposal.md` |
| 2 | 设计拆解 | `steps/02_design_tasks.md` |
| 3 | 提案细化 | `steps/03_refine.md` |
| 4 | 评审提案 | `steps/04_review.md` |
| 5 | Apply 施工 | `steps/05_apply.md` |
| 6 | 归档 | `steps/06_archive.md` |
| 7 | Git 提交 | `steps/07_commit.md` |

**错误处理**：
- 任一阶段失败：记录到 AUDIT.md，继续下一个 CP（不阻塞批量执行）
- 归档条件不满足：记录问题，继续下一个 CP

## 阶段 2：生成执行报告

所有 CP 处理完成后，生成 `BATCH_EXECUTION_REPORT.md`：

```markdown
# 批量执行报告

执行时间：YYYY-MM-DD HH:MM

## 执行摘要

- 计划 CP 数：N
- 成功完成：M
- 失败/跳过：K
- 总耗时：X 小时

## CP 执行详情

### CP-1: [名称] ✓

- 状态：成功
- 耗时：2h 15m
- 提案：changes/2026-01-05-1-xxx/proposal.md
- 审计：changes/2026-01-05-1-xxx/AUDIT.md
- 关键决策：
  - TBD 1: 决策内容（见 DECISIONS.md）
  - TBD 2: 决策内容（见 DECISIONS.md）
- 测试：通过 (单元 42/42, 集成 5/5)

### CP-2: [名称] ⚠️

- 状态：失败 / 暂停
- 耗时：1h 30m
- 原因：xxx
- 建议：xxx

## 审计追踪

| CP | AUDIT.md | 快照数 | 决策数 |
|----|----------|--------|--------|
| CP-1 | [链接](changes/2026-01-05-1-xxx/AUDIT.md) | 5 | 3 |
| CP-2 | [链接](changes/2026-01-05-2-yyy/AUDIT.md) | 3 | 1 |

## 遗留问题

需要人工介入的事项...
```

## 错误处理策略

| 场景 | 处理方式 |
|------|----------|
| 任务执行失败 | 修复重试，最多 3 次；仍失败则记录到 AUDIT.md 并继续下一个 CP |
| 测试失败 | 修复后重测；最多重试 3 次；仍失败则记录原因并继续下一个 CP |
| 需要用户输入 | 基于 openspec/project.md 做合理推断，记录决策到 DECISIONS.md，继续执行 |
| 破坏性变更 | 记录到 AUDIT.md，在最终报告中标注需要人工 review |

**关键原则**：批量执行模式下，任何错误都不应阻塞整个流程，记录问题并继续处理后续 CP。
